--1
--1.1

CREATE TABLE Mitarbeiter (
  MitID char(3) PRIMARY KEY Not Null, 
  MitName VARCHAR(20),
  MitVorname varchar(20),
  MitGebDat Date Not Null,
  MitJob varchar(20) Not Null,
  MitStundensatz smallmoney,
  MitEinsatzort varchar(20)
)

CREATE TABLE Kunde (
  KunNr Int Primary Key Not Null,
  KunName varchar(20) Not Null,
  KunOrt varchar(20) Not Null,
  KunPLZ char(5) Not Null,
  KunStrasse varchar(20) Not Null
)

CREATE TABLE Ersatzteil (
  EtID char(5) Primary key Not Null,
  EtBezeichnung varchar(100) Not Null,
  EtPreis smallmoney Not Null,
  EtAnzLager Int Not Null,
  EtHersteller varchar(30) Not Null
)

--1.2
INSERT INTO Mitarbeiter SELECT * FROM trommelhelden..quelleMitarbeiter
INSERT INTO Kunde SELECT * FROM trommelhelden..quelleKunde
INSERT INTO Ersatzteil SELECT * FROM trommelhelden..quelleErsatzteil

select * from Mitarbeiter 
select * from Kunde
select * from Ersatzteil

--1.3
SELECT * INTO Auftrag FROM trommelhelden..quelleAuftrag
SELECT * INTO Montage FROM trommelhelden..quelleMontage

--1.4
Alter table Auftrag 
  add primary key (AufNr);
  Alter table Auftrag add foreign key (MitID) References Mitarbeiter (MitID);
  Alter table Auftrag add foreign key (KunNr) References Kunde (KunNr);

Alter table Montage
  add primary key (AufNr, EtID);
  Alter table Montage add foreign key (EtID) References Ersatzteil (EtID);
  Alter table Montage add foreign key (AufNr) References Auftrag (AufNr);

--2
--2.1
--a
select * from Kunde where KunOrt = 'Radebeul';
--b
SELECT * FROM Kunde WHERE KunOrt NOT LIKE 'Chemnitz';
--c
select * from Ersatzteil where EtBezeichnung like 'S%';
--d
select * from Auftrag where Dauer between 2 and 3 or Anfahrt >= 80;
--e
select MitName,MitJob from Mitarbeiter where MitEinsatzort = 'Radebeul' Order by MitName; --Ã„ndern Nicht nur MIt
select * from Auftrag where	Dauer is Null;
--g
select KunNr, Anfahrt, Anfahrt*2.5 as Anfahrtskosten from Auftrag;

--2.2
--a
select MitID, MitName, MitVorname, MitGebDat,
case when dateadd(year, Datediff(year, MitGebDat, getdate()), MitGebDat) > getdate()
	then datediff(year, MitGebDat, getdate()) -1
	else datediff(year, MitGebDat, getdate()) end as "Alter"
from Mitarbeiter;

--b
select Aufnr, AufDat, ErlDat, datediff(day, AufDat, ErlDat) as Frist 
from Auftrag where datepart(month, ErlDat) = datepart(month, getdate());

--c

select Aufnr,isnull(Dauer, 0) from Auftrag;

--2.3
--a
select count(KunNr) from Kunde; 
--b
select KunOrt, count(KunNr) as Kundenanzahl from Kunde group by KunOrt;
--c
select MitID, avg(Dauer) as durchschnitt from Auftrag group by MitID;
--d
select MitID, avg(Dauer) as durchschnitt, min(dauer) as minimum, max(dauer) as maximum from Auftrag group by MitID;
--e
select MitID, avg(Dauer) as durchschnitt, ErlDat, count(ErlDat) as Auf_proTag from Auftrag group by MitID, ErlDat;
--f
select min(AufDat) as minimum_Dat from Auftrag where ErlDat is null;

--2.4
--b
select MitID, DATEPART(dw, ErlDat) as Wochentag, AVG(Dauer) as DurchschnittlicheDauer from Auftrag where MitID is not null Group by MitID , DATEPART(weekday,ErlDat);

--2.5
--a
select AufNr, EtBezeichnung, Anzahl, EtPreis , Anzahl * EtPreis As EtKosten from Montage M Join Ersatzteil E on M.EtID = E.EtID;
--b
select AufNr, Dauer * MitStundensatz as Lohnkosten from Auftrag A Join Mitarbeiter M on A.MitID = M.MitID;
--c
select KunName, KunOrt, Anfahrt from Kunde K Join  Auftrag A on K.KunNr = A.KunNr where Anfahrt > 50;
--d
select KunNr from Auftrag A Join Montage M on A.AufNr = M.AufNr where EtID = 'H0230' And datediff(month,getdate(),ErlDat) <= 02;
--e
select a.Aufnr,
	SUM(m.Anzahl*e.EtPreis) as Materialkosten,
	AVG(Dauer*i.MitStundensatz) as Lohnkosten,
	AVG(a.Anfahrt)*0.2 as Fahrtkosten
from Auftrag a Join Montage m on m.AufNr=a.Aufnr Join Mitarbeiter i on i.MitID=a.MitID Join Ersatzteil e on e.EtID=m.EtID 
Group by a.Aufnr
--f
select a.Aufnr, a.AufDat, m.Mitname from Auftrag a Left Join Mitarbeiter m on a.MitID=m.MitID where MONTH(a.AufDat) = MONTH(GETDATE());
--g
select e.EtID,
SUM(m.Anzahl)
from Ersatzteil e Join Montage m on m.EtID=e.EtID Join (select * from Auftrag where MONTH(ErlDat) = MONTH(GETDATE())-1) a on a.Aufnr=m.AufNr
Group by e.EtID;
--2.6
select MitID, 
